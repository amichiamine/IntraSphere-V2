# IntraSphere - Configuration .htaccess API (CORRIGÉE)
# Emplacement : public_html/api/.htaccess
# Type : API PHP fonctionnelle
# Version : 2.1 - Août 2025

# ========================================
# CONFIGURATION CORS POUR L'API
# ========================================

<IfModule mod_headers.c>
    # Autoriser les requêtes depuis le même domaine (sécurisé)
    Header always set Access-Control-Allow-Origin "*"
    # En production, remplacer par votre domaine : 
    # Header always set Access-Control-Allow-Origin "https://votre-domaine.com"
    
    # Méthodes HTTP autorisées
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    
    # En-têtes autorisés
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"
    
    # Durée de mise en cache des requêtes preflight
    Header always set Access-Control-Max-Age "3600"
    
    # Autoriser les cookies/credentials
    Header always set Access-Control-Allow-Credentials "true"
    
    # Headers de sécurité API
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"
</IfModule>

# ========================================
# GESTION DES REQUÊTES OPTIONS (PREFLIGHT)
# ========================================

<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Répondre automatiquement aux requêtes OPTIONS
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]
</IfModule>

# ========================================
# ROUTAGE API PHP
# ========================================

<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Route pour les stats (public)
    RewriteRule ^stats$ stats.php [L]
    
    # Routes d'authentification
    RewriteRule ^auth/login$ auth/login.php [L]
    RewriteRule ^auth/logout$ auth/logout.php [L]
    RewriteRule ^auth/me$ auth/me.php [L]
    
    # Routes des ressources avec ID optionnel
    RewriteRule ^announcements/([a-zA-Z0-9\-]+)$ announcements.php [L]
    RewriteRule ^announcements$ announcements.php [L]
    
    RewriteRule ^users/([a-zA-Z0-9\-]+)$ users.php [L]
    RewriteRule ^users$ users.php [L]
    
    RewriteRule ^documents/([a-zA-Z0-9\-]+)$ documents.php [L]
    RewriteRule ^documents$ documents.php [L]
    
    RewriteRule ^events/([a-zA-Z0-9\-]+)$ events.php [L]
    RewriteRule ^events$ events.php [L]
    
    # Route pour les messages (si implémenté)
    RewriteRule ^messages/([a-zA-Z0-9\-]+)$ messages.php [L]
    RewriteRule ^messages$ messages.php [L]
    
    # Route pour les réclamations (si implémenté)
    RewriteRule ^complaints/([a-zA-Z0-9\-]+)$ complaints.php [L]
    RewriteRule ^complaints$ complaints.php [L]
</IfModule>

# ========================================
# SÉCURITÉ DE L'API
# ========================================

# Limiter la taille des requêtes pour éviter les attaques
LimitRequestBody 10485760 # 10MB

# Bloquer l'accès aux fichiers sensibles
<Files "*.ini">
    Order Allow,Deny
    Deny from all
</Files>

<Files "*.log">
    Order Allow,Deny
    Deny from all
</Files>

<Files "config/*">
    Order Allow,Deny
    Deny from all
</Files>

# Protection contre les injections dans l'URL
<IfModule mod_rewrite.c>
    RewriteCond %{QUERY_STRING} (\<|%3C)([^s]*s)+cript.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2})
    RewriteRule .* - [F]
</IfModule>

# ========================================
# OPTIMISATION API
# ========================================

# Pas de cache pour les réponses API
<IfModule mod_headers.c>
    Header always set Cache-Control "no-cache, no-store, must-revalidate"
    Header always set Pragma "no-cache"
    Header always set Expires "0"
</IfModule>

# Compression des réponses JSON
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE text/plain
</IfModule>

# ========================================
# LOGGING DES ERREURS API
# ========================================

<IfModule mod_log_config.c>
    LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" [API]" api_log
    # Décommenter si vous voulez des logs séparés :
    # CustomLog /home/username/logs/api.log api_log
</IfModule>

# ========================================
# INFORMATIONS D'UTILISATION
# ========================================

# Cette configuration .htaccess permet à l'API PHP de fonctionner
# exactement comme l'API Express.js avec les mêmes routes :
#
# POST   /api/auth/login
# POST   /api/auth/logout  
# GET    /api/auth/me
# GET    /api/stats
# GET    /api/announcements
# POST   /api/announcements
# GET    /api/announcements/{id}
# PUT    /api/announcements/{id}
# DELETE /api/announcements/{id}
# ... et toutes les autres routes
#
# L'application React fonctionnera identiquement avec cette API PHP