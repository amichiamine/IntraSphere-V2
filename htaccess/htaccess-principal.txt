# IntraSphere - Configuration .htaccess principale
# Emplacement : public_html/.htaccess
# Type : Hébergement traditionnel (PHP + MySQL)
# Version : 2.1 - Août 2025

# ========================================
# SÉCURITÉ ET PROTECTION
# ========================================

# Protection contre les attaques par injection
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Bloquer les tentatives d'injection SQL communes
    RewriteCond %{QUERY_STRING} (\<|%3C)([^s]*s)+cript.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} (\<|%3C)([^i]*i)+frame.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} select.*\(.*\) [NC,OR]
    RewriteCond %{QUERY_STRING} union.*select.*\( [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C)([^b]*b)+ody.*(\>|%3E) [NC]
    RewriteRule .* - [F]
</IfModule>

# Protection des fichiers sensibles
<Files ".htaccess">
    Order Allow,Deny
    Deny from all
</Files>

<Files "*.ini">
    Order Allow,Deny
    Deny from all
</Files>

<Files "*.log">
    Order Allow,Deny
    Deny from all
</Files>

<Files "*.env">
    Order Allow,Deny
    Deny from all
</Files>

<Files "diagnostic.php">
    Order Allow,Deny
    Deny from all
</Files>

<Files "test-config.php">
    Order Allow,Deny
    Deny from all
</Files>

# ========================================
# OPTIMISATION ET CACHE
# ========================================

# Compression GZIP
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Cache des ressources statiques
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType font/woff "access plus 1 month"
    ExpiresByType font/woff2 "access plus 1 month"
    ExpiresByType application/font-woff "access plus 1 month"
    ExpiresByType application/font-woff2 "access plus 1 month"
</IfModule>

# ========================================
# CONFIGURATION SPA (SINGLE PAGE APP)
# ========================================

<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # ⚠️  IMPORTANT: Routes API gérées par Express.js en mode Node.js
    # En mode traditionnel PHP, /api/* retournera 404 (comportement normal)
    # Le frontend React gère ces erreurs et affiche les messages appropriés
    RewriteRule ^api/ - [L]
    
    # Gestion des uploads (ne pas rediriger)
    RewriteRule ^uploads/ - [L]
    
    # Gestion des assets statiques (ne pas rediriger)
    RewriteRule ^static/ - [L]
    
    # Fichiers statiques existants (ne pas rediriger)
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]
    
    # Redirection SPA - tout le reste vers index.html
    RewriteRule ^ index.html [L]
</IfModule>

# ========================================
# SÉCURITÉ AVANCÉE
# ========================================

# Headers de sécurité
<IfModule mod_headers.c>
    # Protection XSS
    Header always set X-XSS-Protection "1; mode=block"
    
    # Protection contre le détournement de type MIME
    Header always set X-Content-Type-Options "nosniff"
    
    # Protection contre le clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Référence de politique de sécurité
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Politique de sécurité du contenu (CSP) - Adaptable selon vos besoins
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'"
    
    # HSTS (si HTTPS activé) - Décommentez si vous avez un certificat SSL
    # Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    
    # Interdire l'affichage dans un frame externe
    Header always set X-Permitted-Cross-Domain-Policies "none"
</IfModule>

# Désactiver la signature du serveur
ServerTokens Prod

# ========================================
# GESTION DES ERREURS
# ========================================

# Pages d'erreur personnalisées
ErrorDocument 404 /index.html
ErrorDocument 403 /index.html
ErrorDocument 500 /index.html

# ========================================
# UPLOADS ET TÉLÉCHARGEMENTS
# ========================================

# Limitation de la taille des requêtes
LimitRequestBody 10485760 # 10MB

# Types MIME pour les nouveaux formats
AddType application/json .json
AddType application/javascript .js
AddType text/css .css
AddType image/webp .webp
AddType font/woff .woff
AddType font/woff2 .woff2
AddType application/font-woff .woff
AddType application/font-woff2 .woff2

# ========================================
# OPTIMISATIONS SUPPLÉMENTAIRES
# ========================================

# Cache spécifique pour les API (courte durée)
<LocationMatch "^/api/(announcements|trainings|users)$">
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresDefault "access plus 5 minutes"
    </IfModule>
</LocationMatch>

# Cache long pour les assets statiques
<LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2)$">
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
    </IfModule>
    <IfModule mod_headers.c>
        Header append Cache-Control "public, immutable"
    </IfModule>
</LocationMatch>

# Préchargement des ressources critiques
<IfModule mod_headers.c>
    # Précharger les styles principaux
    Header add Link "</static/css/main.css>; rel=preload; as=style"
    # Précharger le JavaScript principal
    Header add Link "</static/js/main.js>; rel=preload; as=script"
</IfModule>

# ========================================
# PROTECTION ADDITIONNELLE
# ========================================

# Bloquer les bots malveillants
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
    RewriteCond %{HTTP_USER_AGENT} (libwww-perl|wget|python|nikto|curl|scan|java|winhttp|clshttp|loader) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (;|<|>|'|"|\)|\(|%0A|%0D|%27|%3C|%3E|%00) [NC,OR]
    RewriteCond %{REQUEST_URI} (;|<|>|'|"|\)|%0A|%0D|%27|%3C|%3E|%00) [NC]
    RewriteRule .* - [F,L]
</IfModule>

# Protection contre les requêtes trop fréquentes
<IfModule mod_evasive24.c>
    DOSHashTableSize    3097
    DOSPageCount        2
    DOSPageInterval     1
    DOSSiteCount        50
    DOSSiteInterval     1
    DOSBlockingPeriod   3600
</IfModule>